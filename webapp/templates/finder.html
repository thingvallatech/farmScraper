{% extends "base.html" %}

{% block title %}Find Programs for Your Farm - FSA Program Explorer{% endblock %}

{% block content %}
<div class="card">
    <h2 style="margin-bottom: 0.5rem; color: #2c5530;">Find Programs for Your Farm</h2>
    <p style="color: #666; margin-bottom: 2rem;">Answer a few questions about your farm to find programs that match your situation</p>

    <form method="get" action="/finder">
        <!-- Farm Profile (Optional - for eligibility checking) -->
        <details style="margin-bottom: 2rem; padding: 1rem; background: #f8f8f8; border-radius: 4px;">
            <summary style="cursor: pointer; font-weight: bold; color: #2c5530; margin-bottom: 1rem;">
                Farm Profile (Optional - helps check eligibility)
            </summary>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                <div>
                    <label style="display: block; margin-bottom: 0.25rem; font-weight: bold; font-size: 0.9rem;">U.S. Citizen?</label>
                    <select name="is_us_citizen" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">Don't know</option>
                        <option value="yes" {% if farm_profile.is_us_citizen == 'yes' %}selected{% endif %}>Yes</option>
                        <option value="no" {% if farm_profile.is_us_citizen == 'no' %}selected{% endif %}>No</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.25rem; font-weight: bold; font-size: 0.9rem;">Conservation Plan?</label>
                    <select name="conservation_plan" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">Don't know</option>
                        <option value="yes" {% if farm_profile.has_conservation_plan == 'yes' %}selected{% endif %}>Yes</option>
                        <option value="no" {% if farm_profile.has_conservation_plan == 'no' %}selected{% endif %}>No</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.25rem; font-weight: bold; font-size: 0.9rem;">Credit Status</label>
                    <select name="credit_status" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">Don't know</option>
                        <option value="good" {% if farm_profile.credit_status == 'good' %}selected{% endif %}>Good</option>
                        <option value="fair" {% if farm_profile.credit_status == 'fair' %}selected{% endif %}>Fair</option>
                        <option value="poor" {% if farm_profile.credit_status == 'poor' %}selected{% endif %}>Poor</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.25rem; font-weight: bold; font-size: 0.9rem;">Can Get Commercial Credit?</label>
                    <select name="commercial_credit" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">Don't know</option>
                        <option value="yes" {% if farm_profile.can_get_commercial_credit == 'yes' %}selected{% endif %}>Yes</option>
                        <option value="no" {% if farm_profile.can_get_commercial_credit == 'no' %}selected{% endif %}>No</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.25rem; font-weight: bold; font-size: 0.9rem;">Own Farm?</label>
                    <select name="owns_farm" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">Don't know</option>
                        <option value="yes" {% if farm_profile.owns_farm == 'yes' %}selected{% endif %}>Own</option>
                        <option value="no" {% if farm_profile.owns_farm == 'no' %}selected{% endif %}>Rent/Lease</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.25rem; font-weight: bold; font-size: 0.9rem;">Gross Farm Revenue</label>
                    <input type="number" name="gross_revenue" placeholder="e.g., 250000" value="{{ farm_profile.gross_revenue or '' }}" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                    <small style="color: #666; font-size: 0.8rem;">For AGI limit checks</small>
                </div>
            </div>
        </details>

        <!-- Farm Type -->
        <div style="margin-bottom: 2rem;">
            <h3 style="margin-bottom: 1rem;">What type of farm do you operate?</h3>

            <!-- Livestock Types -->
            <div style="margin-bottom: 1.5rem;">
                <h4 style="margin-bottom: 0.75rem; color: #2c5530;">Livestock</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 0.5rem;">
                    <label style="display: flex; align-items: center; padding: 0.5rem; border: 2px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                        <input type="checkbox" name="farm_type" value="beef_cattle" {% if 'beef_cattle' in farm_type %}checked{% endif %} style="margin-right: 0.5rem;">
                        <strong>Beef Cattle</strong>
                    </label>
                    <label style="display: flex; align-items: center; padding: 0.5rem; border: 2px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                        <input type="checkbox" name="farm_type" value="dairy_cattle" {% if 'dairy_cattle' in farm_type %}checked{% endif %} style="margin-right: 0.5rem;">
                        <strong>Dairy Cattle</strong>
                    </label>
                    <label style="display: flex; align-items: center; padding: 0.5rem; border: 2px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                        <input type="checkbox" name="farm_type" value="hogs" {% if 'hogs' in farm_type %}checked{% endif %} style="margin-right: 0.5rem;">
                        <strong>Hogs/Swine</strong>
                    </label>
                    <label style="display: flex; align-items: center; padding: 0.5rem; border: 2px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                        <input type="checkbox" name="farm_type" value="poultry" {% if 'poultry' in farm_type %}checked{% endif %} style="margin-right: 0.5rem;">
                        <strong>Poultry</strong>
                    </label>
                    <label style="display: flex; align-items: center; padding: 0.5rem; border: 2px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                        <input type="checkbox" name="farm_type" value="sheep_goats" {% if 'sheep_goats' in farm_type %}checked{% endif %} style="margin-right: 0.5rem;">
                        <strong>Sheep/Goats</strong>
                    </label>
                    <label style="display: flex; align-items: center; padding: 0.5rem; border: 2px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                        <input type="checkbox" name="farm_type" value="bees" {% if 'bees' in farm_type %}checked{% endif %} style="margin-right: 0.5rem;">
                        <strong>Bees/Honey</strong>
                    </label>
                    <label style="display: flex; align-items: center; padding: 0.5rem; border: 2px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                        <input type="checkbox" name="farm_type" value="aquaculture" {% if 'aquaculture' in farm_type %}checked{% endif %} style="margin-right: 0.5rem;">
                        <strong>Aquaculture/Fish</strong>
                    </label>
                </div>
            </div>

            <!-- Crop Types -->
            <div style="margin-bottom: 1.5rem;">
                <h4 style="margin-bottom: 0.75rem; color: #2c5530;">Crops</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.5rem;">
                    <label style="display: flex; align-items: center; padding: 0.5rem; border: 2px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                        <input type="checkbox" name="farm_type" value="wheat" {% if 'wheat' in farm_type %}checked{% endif %} style="margin-right: 0.5rem;">
                        <strong>Wheat</strong>
                    </label>
                    <label style="display: flex; align-items: center; padding: 0.5rem; border: 2px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                        <input type="checkbox" name="farm_type" value="corn" {% if 'corn' in farm_type %}checked{% endif %} style="margin-right: 0.5rem;">
                        <strong>Corn</strong>
                    </label>
                    <label style="display: flex; align-items: center; padding: 0.5rem; border: 2px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                        <input type="checkbox" name="farm_type" value="soybeans" {% if 'soybeans' in farm_type %}checked{% endif %} style="margin-right: 0.5rem;">
                        <strong>Soybeans</strong>
                    </label>
                    <label style="display: flex; align-items: center; padding: 0.5rem; border: 2px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                        <input type="checkbox" name="farm_type" value="cotton" {% if 'cotton' in farm_type %}checked{% endif %} style="margin-right: 0.5rem;">
                        <strong>Cotton</strong>
                    </label>
                    <label style="display: flex; align-items: center; padding: 0.5rem; border: 2px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                        <input type="checkbox" name="farm_type" value="rice" {% if 'rice' in farm_type %}checked{% endif %} style="margin-right: 0.5rem;">
                        <strong>Rice</strong>
                    </label>
                    <label style="display: flex; align-items: center; padding: 0.5rem; border: 2px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                        <input type="checkbox" name="farm_type" value="barley" {% if 'barley' in farm_type %}checked{% endif %} style="margin-right: 0.5rem;">
                        <strong>Barley</strong>
                    </label>
                    <label style="display: flex; align-items: center; padding: 0.5rem; border: 2px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                        <input type="checkbox" name="farm_type" value="sorghum" {% if 'sorghum' in farm_type %}checked{% endif %} style="margin-right: 0.5rem;">
                        <strong>Sorghum</strong>
                    </label>
                    <label style="display: flex; align-items: center; padding: 0.5rem; border: 2px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                        <input type="checkbox" name="farm_type" value="peanuts" {% if 'peanuts' in farm_type %}checked{% endif %} style="margin-right: 0.5rem;">
                        <strong>Peanuts</strong>
                    </label>
                    <label style="display: flex; align-items: center; padding: 0.5rem; border: 2px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                        <input type="checkbox" name="farm_type" value="sunflower" {% if 'sunflower' in farm_type %}checked{% endif %} style="margin-right: 0.5rem;">
                        <strong>Sunflower</strong>
                    </label>
                    <label style="display: flex; align-items: center; padding: 0.5rem; border: 2px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                        <input type="checkbox" name="farm_type" value="canola" {% if 'canola' in farm_type %}checked{% endif %} style="margin-right: 0.5rem;">
                        <strong>Canola</strong>
                    </label>
                </div>
            </div>

            <!-- Specialty & Other -->
            <div style="margin-bottom: 0.5rem;">
                <h4 style="margin-bottom: 0.75rem; color: #2c5530;">Specialty & Other</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 0.5rem;">
                    <label style="display: flex; align-items: center; padding: 0.5rem; border: 2px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                        <input type="checkbox" name="farm_type" value="fruits" {% if 'fruits' in farm_type %}checked{% endif %} style="margin-right: 0.5rem;">
                        <strong>Fruits</strong>
                    </label>
                    <label style="display: flex; align-items: center; padding: 0.5rem; border: 2px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                        <input type="checkbox" name="farm_type" value="vegetables" {% if 'vegetables' in farm_type %}checked{% endif %} style="margin-right: 0.5rem;">
                        <strong>Vegetables</strong>
                    </label>
                    <label style="display: flex; align-items: center; padding: 0.5rem; border: 2px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                        <input type="checkbox" name="farm_type" value="nuts" {% if 'nuts' in farm_type %}checked{% endif %} style="margin-right: 0.5rem;">
                        <strong>Nuts</strong>
                    </label>
                    <label style="display: flex; align-items: center; padding: 0.5rem; border: 2px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                        <input type="checkbox" name="farm_type" value="hay_forage" {% if 'hay_forage' in farm_type %}checked{% endif %} style="margin-right: 0.5rem;">
                        <strong>Hay/Forage</strong>
                    </label>
                    <label style="display: flex; align-items: center; padding: 0.5rem; border: 2px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                        <input type="checkbox" name="farm_type" value="organic" {% if 'organic' in farm_type %}checked{% endif %} style="margin-right: 0.5rem;">
                        <strong>Organic</strong>
                    </label>
                </div>
            </div>
        </div>

        <!-- Farmer Status -->
        <div style="margin-bottom: 2rem;">
            <h3 style="margin-bottom: 1rem;">Which describes you? <span style="font-size: 0.9rem; font-weight: normal; color: #666;">(Optional - boosts ranking)</span></h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem;">
                <label style="display: flex; align-items: center; padding: 0.75rem; border: 2px solid #ddd; border-radius: 4px; cursor: pointer;">
                    <input type="checkbox" name="farmer_status" value="beginning" {% if 'beginning' in farmer_status %}checked{% endif %} style="margin-right: 0.5rem;">
                    <div>
                        <strong>Beginning Farmer</strong>
                        <div style="font-size: 0.85rem; color: #666;">10 years or less experience</div>
                    </div>
                </label>
                <label style="display: flex; align-items: center; padding: 0.75rem; border: 2px solid #ddd; border-radius: 4px; cursor: pointer;">
                    <input type="checkbox" name="farmer_status" value="young" {% if 'young' in farmer_status %}checked{% endif %} style="margin-right: 0.5rem;">
                    <div>
                        <strong>Young Farmer</strong>
                        <div style="font-size: 0.85rem; color: #666;">Under 35 years old</div>
                    </div>
                </label>
                <label style="display: flex; align-items: center; padding: 0.75rem; border: 2px solid #ddd; border-radius: 4px; cursor: pointer;">
                    <input type="checkbox" name="farmer_status" value="veteran" {% if 'veteran' in farmer_status %}checked{% endif %} style="margin-right: 0.5rem;">
                    <div>
                        <strong>Veteran</strong>
                        <div style="font-size: 0.85rem; color: #666;">Military veteran</div>
                    </div>
                </label>
            </div>
        </div>

        <!-- Program Type -->
        <div style="margin-bottom: 2rem;">
            <h3 style="margin-bottom: 1rem;">What type of assistance do you need?</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem;">
                <label style="display: flex; align-items: center; padding: 0.75rem; border: 2px solid #ddd; border-radius: 4px; cursor: pointer;">
                    <input type="checkbox" name="program_type" value="loans" {% if 'loans' in program_type %}checked{% endif %} style="margin-right: 0.5rem;">
                    <div>
                        <strong>Loans</strong>
                        <div style="font-size: 0.85rem; color: #666;">Financing for operations or land</div>
                    </div>
                </label>
                <label style="display: flex; align-items: center; padding: 0.75rem; border: 2px solid #ddd; border-radius: 4px; cursor: pointer;">
                    <input type="checkbox" name="program_type" value="payments" {% if 'payments' in program_type %}checked{% endif %} style="margin-right: 0.5rem;">
                    <div>
                        <strong>Direct Payments</strong>
                        <div style="font-size: 0.85rem; color: #666;">Subsidies and assistance payments</div>
                    </div>
                </label>
                <label style="display: flex; align-items: center; padding: 0.75rem; border: 2px solid #ddd; border-radius: 4px; cursor: pointer;">
                    <input type="checkbox" name="program_type" value="insurance" {% if 'insurance' in program_type %}checked{% endif %} style="margin-right: 0.5rem;">
                    <div>
                        <strong>Insurance</strong>
                        <div style="font-size: 0.85rem; color: #666;">Crop and revenue protection</div>
                    </div>
                </label>
                <label style="display: flex; align-items: center; padding: 0.75rem; border: 2px solid #ddd; border-radius: 4px; cursor: pointer;">
                    <input type="checkbox" name="program_type" value="conservation" {% if 'conservation' in program_type %}checked{% endif %} style="margin-right: 0.5rem;">
                    <div>
                        <strong>Conservation</strong>
                        <div style="font-size: 0.85rem; color: #666;">Environmental programs</div>
                    </div>
                </label>
            </div>
        </div>

        <!-- Situation -->
        <div style="margin-bottom: 2rem;">
            <h3 style="margin-bottom: 1rem;">What situation brings you here? <span style="font-size: 0.9rem; font-weight: normal; color: #666;">(Optional - boosts ranking)</span></h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem;">
                <label style="display: flex; align-items: center; padding: 0.75rem; border: 2px solid #ddd; border-radius: 4px; cursor: pointer;">
                    <input type="checkbox" name="situation" value="disaster" {% if 'disaster' in situation %}checked{% endif %} style="margin-right: 0.5rem;">
                    <div>
                        <strong>Disaster/Emergency</strong>
                        <div style="font-size: 0.85rem; color: #666;">Drought, flood, or other disaster</div>
                    </div>
                </label>
                <label style="display: flex; align-items: center; padding: 0.75rem; border: 2px solid #ddd; border-radius: 4px; cursor: pointer;">
                    <input type="checkbox" name="situation" value="price_loss" {% if 'price_loss' in situation %}checked{% endif %} style="margin-right: 0.5rem;">
                    <div>
                        <strong>Price Loss</strong>
                        <div style="font-size: 0.85rem; color: #666;">Market prices dropped</div>
                    </div>
                </label>
                <label style="display: flex; align-items: center; padding: 0.75rem; border: 2px solid #ddd; border-radius: 4px; cursor: pointer;">
                    <input type="checkbox" name="situation" value="need_equipment" {% if 'need_equipment' in situation %}checked{% endif %} style="margin-right: 0.5rem;">
                    <div>
                        <strong>Need Equipment</strong>
                        <div style="font-size: 0.85rem; color: #666;">Machinery or storage facilities</div>
                    </div>
                </label>
                <label style="display: flex; align-items: center; padding: 0.75rem; border: 2px solid #ddd; border-radius: 4px; cursor: pointer;">
                    <input type="checkbox" name="situation" value="buy_land" {% if 'buy_land' in situation %}checked{% endif %} style="margin-right: 0.5rem;">
                    <div>
                        <strong>Buying Land</strong>
                        <div style="font-size: 0.85rem; color: #666;">Purchase or expand farmland</div>
                    </div>
                </label>
            </div>
        </div>

        <div style="display: flex; gap: 1rem;">
            <button type="submit" class="btn" style="font-size: 1.1rem; padding: 0.75rem 2rem;">Find Matching Programs</button>
            <a href="/finder" class="btn btn-secondary">Clear All</a>
        </div>
    </form>
</div>

{% if matched_programs %}
<div style="margin-top: 2rem;">
    <h2 style="margin-bottom: 1rem;">
        {% if matched_programs|length > 0 %}
            Found {{ matched_programs|length }} Matching Program{{ 's' if matched_programs|length != 1 else '' }}
        {% else %}
            No Programs Found
        {% endif %}
    </h2>

    {% if matched_programs|length == 0 %}
    <div class="card" style="text-align: center; padding: 3rem;">
        <p style="color: #666; margin-bottom: 1rem;">No programs match your exact criteria.</p>
        <p style="color: #666;">Try selecting fewer options or <a href="/programs" style="color: #2c5530;">browse all programs</a>.</p>
    </div>
    {% endif %}

    <!-- Group results by match score -->
    {% set excellent_matches = [] %}
    {% set good_matches = [] %}
    {% set fair_matches = [] %}
    {% for program in matched_programs %}
        {% if program.match_score >= 90 %}
            {{ excellent_matches.append(program) or '' }}
        {% elif program.match_score >= 70 %}
            {{ good_matches.append(program) or '' }}
        {% else %}
            {{ fair_matches.append(program) or '' }}
        {% endif %}
    {% endfor %}

    <!-- Excellent Matches (90%+) -->
    {% if excellent_matches %}
    <div style="margin-bottom: 2rem;">
        <h3 style="color: #2c5530; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 3px solid #2c5530;">
            Excellent Matches ({{ excellent_matches|length }})
        </h3>
        {% for program in excellent_matches %}
        <div class="card" style="position: relative; border-left: 4px solid #2c5530;">
            <!-- Match Score Badge -->
            <div style="position: absolute; top: 1rem; right: 1rem; background: #2c5530; color: white; padding: 0.5rem 1rem; border-radius: 20px; font-weight: bold;">
                {{ program.match_score }}% Match
            </div>

            <div style="margin-bottom: 0.75rem; padding-right: 120px;">
                <h3 style="color: #2c5530; margin-bottom: 0.5rem;">{{ program.program_name }}</h3>
                {% if program.payment_min %}
                <div style="color: #2c5530; font-weight: bold; margin-bottom: 0.5rem;">
                    ${{ "${:,.0f}".format(program.payment_min) }}
                    {% if program.payment_max and program.payment_max != program.payment_min %}
                     - ${{ "${:,.0f}".format(program.payment_max) }}
                    {% endif %}
                    {% if program.payment_unit %}<span style="font-weight: normal;">({{ program.payment_unit }})</span>{% endif %}
                </div>
                {% endif %}
            </div>

            <!-- AI Summary -->
            {% if program.ai_summary %}
            <div style="background: #f0f7f1; padding: 1rem; border-radius: 4px; margin-bottom: 1rem; line-height: 1.6;">
                <p style="margin: 0; color: #333;">{{ program.ai_summary }}</p>
            </div>
            {% endif %}

            <!-- Eligibility Status -->
            {% if program.eligibility_check and program.eligibility_check.total > 0 %}
            <details style="margin-bottom: 1rem; padding: 1rem; background: #fafafa; border-radius: 4px; border: 1px solid #ddd;">
                <summary style="cursor: pointer; font-weight: bold; color: #2c5530;">
                    Eligibility: {{ program.eligibility_check.met_count }}/{{ program.eligibility_check.total }} requirements met
                    {% if program.eligibility_check.score >= 80 %}
                        <span style="color: green;">✓</span>
                    {% elif program.eligibility_check.score >= 50 %}
                        <span style="color: orange;">~</span>
                    {% else %}
                        <span style="color: #999;">?</span>
                    {% endif %}
                </summary>
                <div style="margin-top: 1rem; font-size: 0.9rem;">
                    {% if program.eligibility_check.met %}
                    <div style="margin-bottom: 0.75rem;">
                        <strong style="color: green;">✓ Requirements Met:</strong>
                        <ul style="margin: 0.5rem 0 0 1.5rem; color: #333;">
                            {% for req in program.eligibility_check.met %}
                            <li style="margin-bottom: 0.25rem;">{{ req.requirement }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                    {% if program.eligibility_check.not_met %}
                    <div style="margin-bottom: 0.75rem;">
                        <strong style="color: #d32f2f;">✗ Requirements Not Met:</strong>
                        <ul style="margin: 0.5rem 0 0 1.5rem; color: #666;">
                            {% for req in program.eligibility_check.not_met %}
                            <li style="margin-bottom: 0.25rem;">{{ req.requirement }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                    {% if program.eligibility_check.unknown %}
                    <div>
                        <strong style="color: #ff9800;">? Verify With FSA Office:</strong>
                        <ul style="margin: 0.5rem 0 0 1.5rem; color: #999;">
                            {% for req in program.eligibility_check.unknown %}
                            <li style="margin-bottom: 0.25rem;">{{ req.requirement }}
                                {% if req.note %}<span style="font-size: 0.85rem; font-style: italic;"> ({{ req.note }})</span>{% endif %}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                </div>
            </details>
            {% endif %}

            <!-- Why this matches -->
            {% if program.why_matches %}
            <div style="margin-bottom: 1rem;">
                <strong style="color: #2c5530; display: block; margin-bottom: 0.5rem;">Why this matches your farm:</strong>
                <ul style="margin: 0; padding-left: 1.5rem; color: #666;">
                    {% for reason in program.why_matches %}
                    <li style="margin-bottom: 0.25rem;">{{ reason }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <div style="display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
                <a href="/program/{{ program.id }}" class="btn">View Full Details</a>
                <a href="{{ program.source_url }}" target="_blank" class="btn btn-secondary">Official FSA Page →</a>
                <button class="btn add-to-my-programs" data-program-id="{{ program.id }}" data-program-name="{{ program.program_name }}" style="background: #28a745;">
                    + Add to My Programs
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Good Matches (70-89%) -->
    {% if good_matches %}
    <div style="margin-bottom: 2rem;">
        <h3 style="color: #666; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #ddd;">
            Good Matches ({{ good_matches|length }})
        </h3>
        {% for program in good_matches %}
        <div class="card" style="position: relative;">
            <!-- Match Score Badge -->
            <div style="position: absolute; top: 1rem; right: 1rem; background: #666; color: white; padding: 0.5rem 1rem; border-radius: 20px; font-weight: bold;">
                {{ program.match_score }}% Match
            </div>

            <div style="margin-bottom: 0.75rem; padding-right: 120px;">
                <h3 style="color: #2c5530; margin-bottom: 0.5rem;">{{ program.program_name }}</h3>
                {% if program.payment_min %}
                <div style="color: #2c5530; font-weight: bold; margin-bottom: 0.5rem;">
                    ${{ "${:,.0f}".format(program.payment_min) }}
                    {% if program.payment_max and program.payment_max != program.payment_min %}
                     - ${{ "${:,.0f}".format(program.payment_max) }}
                    {% endif %}
                    {% if program.payment_unit %}<span style="font-weight: normal;">({{ program.payment_unit }})</span>{% endif %}
                </div>
                {% endif %}
            </div>

            <!-- AI Summary -->
            {% if program.ai_summary %}
            <div style="background: #f8f8f8; padding: 1rem; border-radius: 4px; margin-bottom: 1rem; line-height: 1.6;">
                <p style="margin: 0; color: #333;">{{ program.ai_summary }}</p>
            </div>
            {% endif %}

            <!-- Eligibility Status -->
            {% if program.eligibility_check and program.eligibility_check.total > 0 %}
            <details style="margin-bottom: 1rem; padding: 1rem; background: #fafafa; border-radius: 4px; border: 1px solid #ddd;">
                <summary style="cursor: pointer; font-weight: bold; color: #2c5530;">
                    Eligibility: {{ program.eligibility_check.met_count }}/{{ program.eligibility_check.total }} requirements met
                    {% if program.eligibility_check.score >= 80 %}
                        <span style="color: green;">✓</span>
                    {% elif program.eligibility_check.score >= 50 %}
                        <span style="color: orange;">~</span>
                    {% else %}
                        <span style="color: #999;">?</span>
                    {% endif %}
                </summary>
                <div style="margin-top: 1rem; font-size: 0.9rem;">
                    {% if program.eligibility_check.met %}
                    <div style="margin-bottom: 0.75rem;">
                        <strong style="color: green;">✓ Requirements Met:</strong>
                        <ul style="margin: 0.5rem 0 0 1.5rem; color: #333;">
                            {% for req in program.eligibility_check.met %}
                            <li style="margin-bottom: 0.25rem;">{{ req.requirement }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                    {% if program.eligibility_check.not_met %}
                    <div style="margin-bottom: 0.75rem;">
                        <strong style="color: #d32f2f;">✗ Requirements Not Met:</strong>
                        <ul style="margin: 0.5rem 0 0 1.5rem; color: #666;">
                            {% for req in program.eligibility_check.not_met %}
                            <li style="margin-bottom: 0.25rem;">{{ req.requirement }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                    {% if program.eligibility_check.unknown %}
                    <div>
                        <strong style="color: #ff9800;">? Verify With FSA Office:</strong>
                        <ul style="margin: 0.5rem 0 0 1.5rem; color: #999;">
                            {% for req in program.eligibility_check.unknown %}
                            <li style="margin-bottom: 0.25rem;">{{ req.requirement }}
                                {% if req.note %}<span style="font-size: 0.85rem; font-style: italic;"> ({{ req.note }})</span>{% endif %}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                </div>
            </details>
            {% endif %}

            <!-- Why this matches -->
            {% if program.why_matches %}
            <div style="margin-bottom: 1rem;">
                <strong style="color: #2c5530; display: block; margin-bottom: 0.5rem;">Why this matches your farm:</strong>
                <ul style="margin: 0; padding-left: 1.5rem; color: #666;">
                    {% for reason in program.why_matches %}
                    <li style="margin-bottom: 0.25rem;">{{ reason }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <div style="display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
                <a href="/program/{{ program.id }}" class="btn">View Full Details</a>
                <a href="{{ program.source_url }}" target="_blank" class="btn btn-secondary">Official FSA Page →</a>
                <button class="btn add-to-my-programs" data-program-id="{{ program.id }}" data-program-name="{{ program.program_name }}" style="background: #28a745;">
                    + Add to My Programs
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Fair Matches (50-69%) -->
    {% if fair_matches %}
    <div style="margin-bottom: 2rem;">
        <h3 style="color: #999; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #eee;">
            Fair Matches ({{ fair_matches|length }})
        </h3>
        {% for program in fair_matches %}
        <div class="card" style="position: relative; opacity: 0.9;">
            <!-- Match Score Badge -->
            <div style="position: absolute; top: 1rem; right: 1rem; background: #999; color: white; padding: 0.5rem 1rem; border-radius: 20px; font-weight: bold;">
                {{ program.match_score }}% Match
            </div>

            <div style="margin-bottom: 0.75rem; padding-right: 120px;">
                <h3 style="color: #2c5530; margin-bottom: 0.5rem; font-size: 1.1rem;">{{ program.program_name }}</h3>
                {% if program.payment_min %}
                <div style="color: #666; font-weight: bold; margin-bottom: 0.5rem; font-size: 0.9rem;">
                    ${{ "${:,.0f}".format(program.payment_min) }}
                    {% if program.payment_max and program.payment_max != program.payment_min %}
                     - ${{ "${:,.0f}".format(program.payment_max) }}
                    {% endif %}
                    {% if program.payment_unit %}<span style="font-weight: normal;">({{ program.payment_unit }})</span>{% endif %}
                </div>
                {% endif %}
            </div>

            <!-- AI Summary -->
            {% if program.ai_summary %}
            <p style="color: #666; margin-bottom: 1rem; line-height: 1.6; font-size: 0.95rem;">{{ program.ai_summary }}</p>
            {% endif %}

            <!-- Eligibility Status -->
            {% if program.eligibility_check and program.eligibility_check.total > 0 %}
            <details style="margin-bottom: 1rem; padding: 1rem; background: #fafafa; border-radius: 4px; border: 1px solid #ddd; font-size: 0.9rem;">
                <summary style="cursor: pointer; font-weight: bold; color: #666;">
                    Eligibility: {{ program.eligibility_check.met_count }}/{{ program.eligibility_check.total }} requirements met
                    {% if program.eligibility_check.score >= 80 %}
                        <span style="color: green;">✓</span>
                    {% elif program.eligibility_check.score >= 50 %}
                        <span style="color: orange;">~</span>
                    {% else %}
                        <span style="color: #999;">?</span>
                    {% endif %}
                </summary>
                <div style="margin-top: 1rem; font-size: 0.85rem;">
                    {% if program.eligibility_check.met %}
                    <div style="margin-bottom: 0.75rem;">
                        <strong style="color: green;">✓ Requirements Met:</strong>
                        <ul style="margin: 0.5rem 0 0 1.5rem; color: #333;">
                            {% for req in program.eligibility_check.met %}
                            <li style="margin-bottom: 0.25rem;">{{ req.requirement }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                    {% if program.eligibility_check.not_met %}
                    <div style="margin-bottom: 0.75rem;">
                        <strong style="color: #d32f2f;">✗ Requirements Not Met:</strong>
                        <ul style="margin: 0.5rem 0 0 1.5rem; color: #666;">
                            {% for req in program.eligibility_check.not_met %}
                            <li style="margin-bottom: 0.25rem;">{{ req.requirement }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                    {% if program.eligibility_check.unknown %}
                    <div>
                        <strong style="color: #ff9800;">? Verify With FSA Office:</strong>
                        <ul style="margin: 0.5rem 0 0 1.5rem; color: #999;">
                            {% for req in program.eligibility_check.unknown %}
                            <li style="margin-bottom: 0.25rem;">{{ req.requirement }}
                                {% if req.note %}<span style="font-size: 0.85rem; font-style: italic;"> ({{ req.note }})</span>{% endif %}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                </div>
            </details>
            {% endif %}

            <!-- Why this matches -->
            {% if program.why_matches %}
            <div style="margin-bottom: 1rem;">
                <strong style="color: #666; display: block; margin-bottom: 0.5rem; font-size: 0.9rem;">Why this matches:</strong>
                <ul style="margin: 0; padding-left: 1.5rem; color: #999; font-size: 0.85rem;">
                    {% for reason in program.why_matches %}
                    <li style="margin-bottom: 0.25rem;">{{ reason }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <div style="display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
                <a href="/program/{{ program.id }}" class="btn" style="font-size: 0.9rem;">View Full Details</a>
                <button class="btn add-to-my-programs" data-program-id="{{ program.id }}" data-program-name="{{ program.program_name }}" style="background: #28a745; font-size: 0.9rem;">
                    + Add to My Programs
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endif %}

<style>
label:has(input[type="checkbox"]:checked) {
    background: #f0f7f1;
    border-color: #2c5530 !important;
}

label:hover {
    border-color: #2c5530 !important;
    background: #fafafa;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Manage "My Programs" list
    function getMyPrograms() {
        return JSON.parse(localStorage.getItem('myPrograms') || '[]');
    }

    function saveMyPrograms(programs) {
        localStorage.setItem('myPrograms', JSON.stringify(programs));
        updateMyProgramsCounter();
    }

    function isProgramAdded(programId) {
        const programs = getMyPrograms();
        const id = parseInt(programId);
        return programs.some(p => p.id === id);
    }

    function addProgram(programId, programName) {
        const programs = getMyPrograms();
        const id = parseInt(programId);
        if (!isProgramAdded(programId)) {
            programs.push({ id: id, name: programName });
            saveMyPrograms(programs);
            return true;
        }
        return false;
    }

    function removeProgram(programId) {
        const programs = getMyPrograms();
        const id = parseInt(programId);
        const filtered = programs.filter(p => p.id !== id);
        saveMyPrograms(filtered);
    }

    // Update button states on page load
    document.addEventListener('DOMContentLoaded', function() {
        const buttons = document.querySelectorAll('.add-to-my-programs');
        buttons.forEach(button => {
            const programId = button.getAttribute('data-program-id');
            if (isProgramAdded(programId)) {
                button.textContent = '✓ Added';
                button.style.background = '#6c757d';
            }

            button.addEventListener('click', function(e) {
                e.preventDefault();
                const programId = this.getAttribute('data-program-id');
                const programName = this.getAttribute('data-program-name');

                if (isProgramAdded(programId)) {
                    removeProgram(programId);
                    this.textContent = '+ Add to My Programs';
                    this.style.background = '#28a745';
                } else {
                    addProgram(programId, programName);
                    this.textContent = '✓ Added';
                    this.style.background = '#6c757d';
                }
            });
        });
    });
</script>
{% endblock %}
